# アンケートシステム 実装計画

## 1. 現状整理

### 1.1 既にあるもの

| 項目 | 内容 |
|------|------|
| **アンケート定義** | `src/lib/survey-config.ts` で事前・事後アンケートの設問がコードで固定定義 |
| **設問タイプ** | `rating` / `text` / `select` / `nps`（`SurveyQuestion` 型） |
| **汎用フォーム** | `SurveyForm` が `questions` と `onSubmit` を受け取り描画・送信 |
| **回答ページ** | `/seminars/[id]/pre-survey?rid=xxx`, `/seminars/[id]/post-survey?rid=xxx` |
| **API** | `POST /api/surveys/pre`, `POST /api/surveys/post` で回答をスプレッドシートに追記 |
| **結果表示** | 管理画面「アンケート結果」で `GET /api/surveys/results` によりスプレッドシートから取得・表示 |
| **Google 側** | セミナーごとスプレッドシートに「事前アンケート」「事後アンケート」シートあり。ヘッダー行固定で回答を追記 |

### 1.2 まだないもの

- **設問定義の保存先**（現状はコード内の定数のみ）→ **各セミナーのスプレッドシートに設問シートを追加する形で対応**
- **アンケートページが設問をスプレッドシートから読み込む仕組み**
- **管理者がメール送信する際に使う「アンケートページのリンク情報」の提供**（メール送信そのものは対象外）

---

## 2. 方針（確定）

### 2.1 マスターシート

- **アンケートの質問項目の詳細はマスターには持たない。**
- マスターには **基本定義** と **各シートへのリンク情報のみ** とする。
  - 現状どおり「セミナー一覧」でセミナーごとの `spreadsheet_id` を持ち、それで「そのセミナー用スプレッドシート」を参照する形で十分。

### 2.2 アンケート設問の保存先

- **アンケートの質問は、各セミナーのスプレッドシートに、独立したシートとして記載する。**
- 各セミナー用スプレッドシートに、例として次のシートを追加する想定：
  - **「事前アンケート設問」** … 事前アンケートの設問一覧
  - **「事後アンケート設問」** … 事後アンケートの設問一覧
- **アンケートページ**は、この設問シートの情報を読み込み、表示・回答を受け付ける。

### 2.3 メール送信

- **メール送信は、管理者がスプレッドシートのリストを見ながら自ら行う。**
- システムが行うのは **「アンケートページのリンク情報」を提供すること** までとする。
  - 例：予約一覧（管理画面 or スプレッドシート）に「事前アンケートURL」「事後アンケートURL」のような形でリンクを用意し、管理者がそれをコピーしてメールに貼る。
- **メール送信の接続（Gmail API 等）は検討対象外** とする。

---

## 3. 目指す流れ（要件）

1. **各セミナー用スプレッドシート**に「事前アンケート設問」「事後アンケート設問」シートがあり、管理者がそこで設問を編集する（または管理画面から編集し、その内容がスプレッドシートに反映される）。
2. **アンケートページ**（`/seminars/[id]/pre-survey?rid=xxx` 等）は、**そのセミナーのスプレッドシートの設問シートを読み込み**、設問を表示して回答を受け付ける。
3. **管理者**は、予約一覧（スプレッドシート or 管理画面）を見ながら、参加者にメールを送る。その際、**添付するアンケートページのリンク情報**（URL）をシステム側で用意しておく。
4. 参加者がリンクから回答し、回答は既存どおり **同じセミナー用スプレッドシートの「事前アンケート」「事後アンケート」シートに蓄積**する。

---

## 4. 汎用アンケートモジュールの設計

### 4.1 方針

- 既存の `SurveyQuestion` 型と `SurveyForm` をそのまま活用する。
- **設問リストの取得元**を「コードの定数」から「**セミナー用スプレッドシートの設問シート**」に切り替える。
- マスターには設問の詳細は持たず、セミナー一覧の `spreadsheet_id` から「そのセミナーの設問シート」を参照する。

### 4.2 モジュール構成（案）

```
src/lib/survey/
  types.ts        # SurveyQuestion 等の型（既存 survey-config の型を移行・拡張）
  config.ts       # 既存のデフォルト設問（フォールバック用：設問シートが空・未作成のとき）
  storage.ts      # セミナー用スプレッドシートの「事前/事後アンケート設問」シートから設問を取得
```

- **storage** は「spreadsheet_id + 事前 or 事後」を引数に、設問シートの行を読み、`SurveyQuestion[]` に変換して返す。
- 回答の送信・スプレッドシートへの追記は **既存 API** のまま。設問の並び・列との対応は、設問シートの「設問ID」や「表示順」と回答シートの列を対応させる設計にする（後述）。

---

## 5. Google 側（スプレッドシート）の設計

### 5.1 マスターシート

- **変更なし。** セミナー一覧に `spreadsheet_id` があり、それで各セミナー用スプレッドシートを参照する。
- アンケートの質問項目の詳細は持たない。

### 5.2 各セミナー用スプレッドシート（新規シート追加）

- 既存の「イベント情報」「予約情報」「事前アンケート」「事後アンケート」に加え、次の **設問用シート** を追加する。
  - **「事前アンケート設問」**
  - **「事後アンケート設問」**

#### 設問シートの列案（共通）

| 列 | 内容 | 例 |
|----|------|-----|
| A: 設問ID | 回答シートの列と対応する一意ID | q1_interest_level |
| B: ラベル | 画面上の質問文 | このセミナーへの関心度を教えてください |
| C: タイプ | rating / text / select / nps | rating |
| D: 必須 | TRUE / FALSE | TRUE |
| E: 選択肢 | select 用。カンマ区切り | 初めて,1年未満,1〜3年,3年以上 |
| F: min | rating / nps の最小値 | 1 |
| G: max | rating / nps の最大値 | 5 |
| H: プレースホルダ | text 用 | 自由にご記入ください |
| I: 表示順 | 並び順（数値） | 1 |

- 1 行目はヘッダー行。2 行目以降が設問。
- アンケートページは、このシートを読み込んで `SurveyQuestion[]` を組み立て、`SurveyForm` に渡す。

### 5.3 回答シート（事前アンケート・事後アンケート）との対応

- **初回実装**：設問シートの「設問ID」の並び順 = 回答シートの列の並び順とし、回答送信時に「設問ID の並び」で値を並べて追記する。
- 既存の「事前アンケート」「事後アンケート」シートのヘッダーは、設問シートの設問ID を元に動的につけるか、または「ID, 予約ID, 設問1, 設問2, … , 回答日時, 備考」のように列を設問順で扱う。
- 既存の固定列（4問/6問）から、設問シートの行数に合わせた動的列に拡張する場合は、ヘッダー行の更新と `appendRow` の値の組み立てを設問順で行う。

### 5.4 セミナー用スプレッドシート作成時の変更

- `createSeminarSpreadsheet` で、新規作成時に「事前アンケート設問」「事後アンケート設問」シートを追加し、上記ヘッダー行と、既存のデフォルト設問に相当する初期行を入れておく（空でも可）。既存セミナー用スプレッドシートには、手動またはマイグレーションで同シートを追加する。

---

## 6. アンケートページのリンク情報（メール用）

- 管理者がメールで依頼する際に添付する **アンケートページのリンク** は、次の形式で一意に決まる。
  - 事前: `https://(サイトURL)/seminars/(seminar_id)/pre-survey?rid=(reservation_id)`
  - 事後: `https://(サイトURL)/seminars/(seminar_id)/post-survey?rid=(reservation_id)`
- **提供方法の案：**
  - **管理画面の予約一覧**に「事前アンケートURL」「事後アンケートURL」列（またはボタンでコピー）を表示する。
  - または **API** で予約一覧を返す際に各予約に `pre_survey_url`, `post_survey_url` を含め、管理画面やスプレッドシート連携で利用する。
- 管理者はそのリスト（またはスプレッドシートの予約情報）を見ながら、自身のメール環境で送信する。**メール送信の接続は実装しない。**

---

## 7. 実装フェーズ案

### Phase 1: セミナー用スプレッドシートに設問シートを追加し、アンケートページで読み込む

1. **Google 側**
   - セミナー用スプレッドシート作成処理（`createSeminarSpreadsheet`）に「事前アンケート設問」「事後アンケート設問」シートを追加。
   - ヘッダー行と、既存のデフォルト設問に相当する初期データを入れる（既存挙動に近い状態にする）。
   - 既存のセミナー用スプレッドシートには、手動またはスクリプトで同シートを追加する方針を記載。

2. **アプリ（storage）**
   - `src/lib/survey/storage.ts` を追加。
   - `getSurveyQuestions(spreadsheetId, type: 'pre' | 'post')` を実装し、該当する設問シートを読み、`SurveyQuestion[]` に変換して返す。
   - 設問シートが存在しない・空の場合は、既存の `survey-config` のデフォルト設問を返す（フォールバック）。

3. **API**
   - アンケートページから呼ぶため、設問取得用 API を用意する（例: `GET /api/seminars/[id]/survey-questions?type=pre|post`）。内部で `spreadsheet_id` を取得し、`getSurveyQuestions(spreadsheetId, type)` を実行して返す。

4. **アンケートページ**
   - `/seminars/[id]/pre-survey` および `post-survey` で、設問を **上記 API（＝セミナー用スプレッドシートの設問シート）** から取得するように変更。
   - 取得失敗時は既存の `preSurveyQuestions` / `postSurveyQuestions` にフォールバック。

5. **管理画面（設問編集）**
   - 各セミナーについて「事前アンケート設問」「事後アンケート設問」を編集する画面を用意する。
   - 編集結果はセミナー用スプレッドシートの該当設問シートに書き込む（API: 例 `PUT /api/seminars/[id]/survey-questions`）。または、管理者がスプレッドシート上で直接編集する運用でも可（その場合は管理画面の編集は後回しでもよい）。

### Phase 2: 回答シートの動的化（設問の増減に対応）

- 設問シートの行数・設問IDに合わせて、「事前アンケート」「事後アンケート」シートのヘッダーとデータ行を動的にする。
- `POST /api/surveys/pre`, `POST /api/surveys/post` で、設問シートを読み、設問IDの並び順で回答値を組み立ててから `appendRow` する。

### Phase 3: アンケートリンク情報の提供

- 管理画面の予約一覧に、各予約に対する「事前アンケートURL」「事後アンケートURL」を表示（表示のみ or コピーボタン）。
- 必要に応じて、予約一覧 API のレスポンスに `pre_survey_url`, `post_survey_url` を含め、管理者がスプレッドシート等で利用しやすい形にする。

---

## 8. 次のアクション（開発に移る前の確認）

1. **設問シートの列仕様**  
   - 上記の列案（設問ID, ラベル, タイプ, 必須, 選択肢, min, max, プレースホルダ, 表示順）で問題ないか。不足・変更したい列があれば指定。

2. **既存セミナー用スプレッドシート**  
   - 「事前アンケート設問」「事後アンケート設問」シートは、新規作成時のみ自動追加とし、既存分は手動で追加するか。  
   - それとも、既存分にも一括でシート追加するスクリプトを用意するか。

3. **管理画面で設問を編集するか**  
   - 設問は「スプレッドシート上で直接編集」のみとするか。  
   - 管理画面から編集する画面を Phase 1 で用意するか。

上記が決まれば、Phase 1 の「設問シートの仕様」と「storage + API + アンケートページの読み込み」から実装に進めます。
