# 招待コード・予約番号・変更・キャンセル 設計方針（案）

実装前に確認いただくための方針メモです。セキュリティと実装の観点で検討した内容をまとめています。

---

## 1. 招待コード（会員限定セミナー用）

### 仕様
- **目的**: 非会員（会員企業ドメイン以外のメール）でも、招待コードがあれば会員限定セミナーに申し込める。
- **設定**: セミナーごとに管理画面で「招待コード」を任意設定（例: `whgc2026`）。
- **判定順**: 会員限定セミナー申し込み時  
  1. メールドメインが会員企業 → そのまま受付  
  2. メールドメインが非会員 → リクエストの `invitation_code` が、そのセミナーの招待コードと一致すれば受付  
  3. どちらも満たさない → 受付不可（後述のモーダル＋一覧へ遷移）

### データ
- **マスター「セミナー一覧」**: 列を1つ追加（例: 「招待コード」）。空欄なら「招待なし」。
- **申し込みフォーム**: 会員限定セミナーでは「招待コード」（任意）入力欄を表示。

### 画面制御
- 非会員かつ招待コードなし（または不一致）で申し込みボタン送信 → **API が 403 を返す**  
  → クライアントで「このセミナーは会員限定のものとなります」を**モーダル（アラート）表示**  
  → 閉じたら **セミナー一覧（`/seminars`）へ遷移**。

### セキュリティ
- 招待コードは「知っていれば申し込める」程度の共有シークレット。漏れれば第三者も申し込める。
- 管理画面でセミナーごとに設定・変更できるようにする。必要なら運用で定期的に変更。
- 招待コードは一覧APIや公開ページには出さず、申し込み時のみサーバーで照合する。

---

## 2. 予約番号（最大8桁程度）

### 形式案
- **表示例**: `2604-a1bc`（ハイフン含め9文字、ハイフン除き8文字）
- **構成**:
  - **開催年月（4桁）**: セミナー開催日の YYMM（例: 2026年4月 → `2604`）
  - **セミナー識別（2桁）**: そのセミナーを一意に表す短いコード（英数字、例: `a1`）
  - **受付番号（2桁）**: そのセミナー内の申込順（01〜99 や a〜z など、例: `bc`）

### 生成ロジック（確定）
- **開催年月**: `seminar.date` から YYMM を算出（4桁数字）。
- **セミナー識別**: 36進法2桁（0–9, a–z）。マスターの行番号やIDから生成。36×36＝1,296 セミナーまで対応可能。
- **受付番号**: 36進法2桁。そのセミナーの「予約情報」シートの既存件数＋1 を36進2桁に変換。同一セミナーで最大 1,296 件まで。

この組み合わせで「2604-a1bc」形式を生成し、**1予約につき1つの予約番号**を発行する。

### 一意性・検索
- 予約番号は**システム内で一意**とする（開催年月＋セミナー識別＋受付番号で衝突しない設計）。
- 管理側の検索は「予約番号」で行えるようにする（スプレッドシートの列で保持）。

### データ保持
- **セミナー専用スプレッドシート「予約情報」**: 列を1つ追加（例: L列「予約番号」）。  
  - 新規予約作成時に上記ルールで予約番号を生成し、その行に書き込む。  
- **既存予約**: 現在登録されているリストはダミーのため削除予定。既存データのマイグレーションや予約番号の遡及付与は行わない。

---

## 3. 予約番号を使った「変更・キャンセル」の流れ

### メール文面
- **予約ID（UUID）の代わりに「予約番号」を記載**（例: `2604-a1bc`）。
- **予約番号はURLに含めない**（セキュリティのため）。
- **変更・キャンセルページ**: メール本文では**リンク**で表示し、ユーザーがクリックして遷移する。
- **予約番号**: メール本文には**テキスト**として記載する。変更・キャンセル画面ではユーザーがその番号を**コピー＆ペースト**して入力する。

### ユーザー操作イメージ
1. メールの「変更・キャンセル」ボタン（リンク）をクリック  
   → **予約番号を入力する画面**に遷移（例: `/booking/manage` など）。
2. ユーザーが **予約番号**（例: `2604-a1bc`）を入力して「確認」。
3. サーバーで予約番号を照合し、一致する予約が1件だけあれば  
   → **そのセミナーの申し込み内容（変更・キャンセル）画面**を表示。  
   - スプレッドシートの「予約情報」から取得した氏名・メール・会社名・部署・電話番号などを表示／編集可能に。
4. 「変更」時: 編集内容をAPI（PUT）で送信し、スプレッドシートの該当行を更新。
5. 「キャンセル」時: キャンセルAPI（DELETE）を呼び、ステータス更新とキャンセルメール送信。

### セキュリティ上の検討

- **認証の代わりに「予約番号」のみでアクセス**
  - 会員ログインがないため、**予約番号を知っていること**が「その予約の操作権」の根拠になる。
  - 予約番号は「8桁程度」で、総数が有限なので、**総当たり（ブルートフォース）** のリスクがある。

- **緩和策**
  1. **予約番号の照合回数を制限する（レート制限）**  
     - 例: 同一IPあたり「N回/分」まで。失敗が続いたら一時ブロック。  
     - これで「何万通りも試す」ことを防ぐ。
  2. **照合結果を区別しない**  
     - 「予約番号が見つかりません」など、**存在する／しないを言い分けない**メッセージに統一。  
     - 有効な番号を推測しにくくする。
  3. **HTTPS必須**  
     - 予約番号や変更内容が平文で流れないようにする。
  4. **メールリンクに予約番号を含めない**  
     - リンクは「変更・キャンセルページ」（予約番号入力画面）のみを指す（例: `https://example.com/booking/manage`）。  
     - 予約番号はメール本文に**テキスト**で記載し、ユーザーはその画面で**コピー＆ペースト**して入力する。  
     - URLに予約番号を含めないことで、メール転送や履歴流出時の漏洩を防ぐ。
  5. **変更・キャンセルAPI**  
     - 変更（PUT）・キャンセル（DELETE）のリクエストには **予約番号（または予約番号で取得した予約ID）** を含め、  
       サーバー側で「その予約番号に紐づく予約だけ」を更新／キャンセルする。  
     - 他者の予約を操作できないようにする。

- **結論**  
  - 上記を満たせば、「会員ログインなし・予約番号のみ」でも、実用上許容できるレベルにできる。  
  - 招待コードと同様、招待コード・予約番号の取り扱い（メール転送禁止など）は利用規約や注意書きで補足するのがよい。

---

## 4. 重複申込（同一メール・同一セミナー）

### 仕様
- **同一** = 同じセミナーID ＋ 同じメールアドレス（前後空白除去・大文字小文字は同一視して比較）。
- **既に「確定」の予約が1件ある場合**:
  - 新規の予約行は**追加しない**。
  - **「登録完了」メールは再送**する。
  - 再送メールの**先頭に注釈の一文を追加**する。  
    例: 「すでに次の内容で登録されています。変更する場合は、メール内の変更・キャンセルリンクからお手続きください。」
  - レスポンスは **201** のまま「予約完了」として返してよい（クライアントは従来どおり完了画面へ）。  
    必要に応じて body に `already_registered: true` を付与し、クライアントで「すでに登録済みです。確認メールを再送しました。」と表示する。

### 実装イメージ
- 予約API（POST）で、該当セミナーの「予約情報」シートを参照し、  
  `メールアドレス === 申込メール && ステータス === "confirmed"` の行が既にあるか確認。  
- あれば「新規行の追加」と「current_bookings の加算」は行わず、既存予約の情報でメール再送＋上記文言を付与。

---

## 5. メール文面の変更

### 受付完了メール
- **予約ID（UUID）の記載をやめ、「予約番号」を記載**する（テキストとして。URLには含めない）。
- **変更・キャンセル**
  - **変更・キャンセルページ**: メール本文に**リンク**で表示する。ユーザーがクリックすると予約番号入力画面に遷移する。
  - **予約番号**: メール本文に**テキスト**で記載する（例: 予約番号: 2604-a1bc）。ユーザーは変更・キャンセル画面でコピー＆ペーストして入力する。
  - 文言例: 「以下の予約番号と、下記の変更・キャンセルリンクから、内容の変更やキャンセルができます。」

### 重複申込時メール
- 既存登録に対する「登録内容の再送」メールの**先頭に注釈の一文を追加**する。  
  例: 「すでに次の内容で登録されています。変更する場合は、メール内の変更・キャンセルリンクからお手続きください。」

---

## 6. 実装時のデータ変更まとめ

| 対象 | 変更内容 |
|------|----------|
| マスター「セミナー一覧」 | 列追加: 「招待コード」（任意）。既存列はそのまま。 |
| セミナー専用「予約情報」 | 列追加: 「予約番号」。新規予約作成時に36進法で生成・保存。既存ダミーデータは削除予定のためマイグレーション不要。 |
| 予約作成API（POST） | 会員判定＋招待コード判定、重複チェック、予約番号生成・保存、メールでは予約番号と重複時文言を送る。 |
| メール（Resend） | 本文で「予約ID」→「予約番号」（テキスト記載）。変更・キャンセルはリンクで表示（URLに予約番号は含めない）。予約番号はコピー＆ペースト用にテキストで記載。重複時は先頭に注釈の一文を追加。 |
| 新規ページ | 予約番号入力ページ（例: `/booking/manage`）。入力→照合→該当セミナーの変更・キャンセル画面へ。 |
| 既存「変更・キャンセル」画面 | 現状は `rid`（UUID）で参照しているため、**予約番号で検索した結果の予約ID**を使って同じ画面・APIを利用する形に寄せる。 |

---

## 7. 確認したい点（未定の場合）

1. **予約番号の「セミナー識別」**  
   - 36進法2桁で自動生成（行番号やIDから）で進める。管理画面でセミナーごとに「短縮コード」を設定する必要があれば別途検討。
2. **既存予約の予約番号**  
   - **確定**: 現在の登録者リストはダミー削除予定のため、既存データのマイグレーションは行わない。
3. **重複申込時のHTTPレスポンス**  
   - 201 のまま「予約完了」で返し、必要に応じて body に `already_registered: true` を付与する。
4. **変更・キャンセル画面のURL**  
   - 予約番号入力ページを `/booking/manage` とするか、`/seminars/[id]/manage` 内で「予約番号を入力してください」から始めるかは実装時に決定可能。

この方針で開発に入ります。修正や追加の要望があれば教えてください。
